<style>
  .form-group {
    margin-bottom: 1rem;
  }
  
  .form-control {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  
  .btn {
    padding: 8px 16px;
    background-color: #00c0f3;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 8px;
  }
  
  .btn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }
  
  .btn-success {
    background-color: #4CAF50;
  }
  
  .info-message {
    color: #00c0f3;
    display: none;
    margin-top: 10px;
    font-size: 14px;
  }
  
  .error-message {
    color: red;
    display: none;
    margin-top: 10px;
    font-size: 14px;
  }
  
  .loading {
    display: none;
    margin-top: 10px;
    font-size: 14px;
  }
  
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-left-color: #00c0f3;
    border-radius: 50%;
    vertical-align: middle;
    margin-right: 5px;
    animation: spin 1s linear infinite;
  }
  
  .device-info {
    display: none;
    margin-top: 15px;
    padding: 12px;
    background-color: #f5f5f5;
    border-radius: 4px;
  }
  
  .device-name {
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .test-container {
    margin-top: 15px;
  }
  
  .add-container {
    text-align: center;
    margin-top: 30px;
    padding-top: 15px;
    border-top: 1px solid #eee;
  }
  
  .add-button {
    display: none;
    width: 100%;
    padding: 12px;
    font-size: 16px;
    margin-top: 10px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<div class="form-group">
  <label for="ip-address">IP Address</label>
  <input type="text" id="ip-address" class="form-control" placeholder="192.168.1.100">
</div>

<div class="test-container">
  <button id="test-button" class="btn">Test Connection</button>
</div>

<div id="device-info" class="device-info">
  <div class="device-name" id="device-name">Device Name</div>
  <div id="device-address">IP Address: </div>
</div>

<div id="loading" class="loading"><span class="spinner"></span> Testing connection...</div>
<div id="info-message" class="info-message"></div>
<div id="error-message" class="error-message"></div>

<div class="add-container">
  <button id="add-button" class="btn btn-success add-button">Add Device</button>
</div>

<script>
  // Helper to log to Homey
  function logToHomey(message) {
    // Log to console as well for debugging
    console.log(message);
    
    // Send log to Homey driver
    Homey.emit('log', `[MANUAL ENTRY] ${message}`)
      .catch(err => console.error('Error logging to Homey:', err));
  }
  
  // Debug logging
  logToHomey('MANUAL ENTRY TEMPLATE LOADED - Debug v1.0.4');
  
  const ipAddressInput = document.getElementById('ip-address');
  const testButton = document.getElementById('test-button');
  const addButton = document.getElementById('add-button');
  const deviceInfo = document.getElementById('device-info');
  const deviceName = document.getElementById('device-name');
  const deviceAddress = document.getElementById('device-address');
  const infoMessage = document.getElementById('info-message');
  const errorMessage = document.getElementById('error-message');
  const loading = document.getElementById('loading');
  
  // Store the device data
  let deviceData = null;
  
  // Validate IP address using regex
  function isValidIP(ip) {
    const regex = /^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;
    if (!regex.test(ip)) return false;
    
    const parts = ip.split('.');
    for (let i = 0; i < parts.length; i++) {
      const part = parseInt(parts[i], 10);
      if (part < 0 || part > 255) return false;
    }
    return true;
  }
  
  // Event listener for Test Connection button
  testButton.addEventListener('click', function() {
    const ip = ipAddressInput.value.trim();
    logToHomey(`Testing connection to IP: ${ip}`);
    
    // Reset UI
    deviceInfo.style.display = 'none';
    addButton.style.display = 'none';
    infoMessage.style.display = 'none';
    
    // Validate IP address
    if (!ip) {
      errorMessage.textContent = "IP address is required";
      errorMessage.style.display = 'block';
      return;
    }
    
    if (!isValidIP(ip)) {
      errorMessage.textContent = "Please enter a valid IP address";
      errorMessage.style.display = 'block';
      return;
    }
    
    // Clear error and show loading
    errorMessage.style.display = 'none';
    loading.textContent = 'Testing connection...';
    loading.style.display = 'block';
    testButton.disabled = true;
    
    logToHomey('Testing connection to WLED device at IP: ' + ip);
    
    // Send data to driver
    Homey.emit('manual_entry', { ip: ip })
      .then(result => {
        logToHomey('Connection test successful: ' + JSON.stringify(result, null, 2));
        
        // Store the device data
        deviceData = result;
        
        // Debug the device data
        logToHomey(`Device data received:
Name: ${result.name}
ID: ${result.data.id}
Address: ${result.settings.address}`);
        
        // Update UI to show device info
        deviceName.textContent = result.name;
        deviceAddress.textContent = `IP Address: ${result.settings.address}`;
        deviceInfo.style.display = 'block';
        
        // Show success message and add button
        infoMessage.textContent = 'Connection successful! Click the button below to add this device.';
        infoMessage.style.display = 'block';
        addButton.style.display = 'block';
        
        // Hide loading
        loading.style.display = 'none';
        testButton.disabled = false;
      })
      .catch(error => {
        logToHomey('Error testing connection: ' + error.message);
        errorMessage.textContent = error.message || "Could not connect to WLED device";
        errorMessage.style.display = 'block';
        loading.style.display = 'none';
        testButton.disabled = false;
      });
  });
  
  // Event listener for Add Device button
  addButton.addEventListener('click', function() {
    if (!deviceData) {
      errorMessage.textContent = "Device data not available. Please test the connection again.";
      errorMessage.style.display = 'block';
      return;
    }
    
    // Add debugging
    logToHomey('MANUAL ENTRY - DEVICE DATA: ' + JSON.stringify(deviceData, null, 2));
    logToHomey('MANUAL ENTRY - Device name: ' + deviceData.name);
    logToHomey('MANUAL ENTRY - Device ID: ' + deviceData.data.id);
    logToHomey('MANUAL ENTRY - Device settings: ' + JSON.stringify(deviceData.settings, null, 2));
    
    // Log device creation
    logToHomey(`Creating device from MANUAL entry:
Name: ${deviceData.name}
ID: ${deviceData.data.id}
Address: ${deviceData.settings.address}`);
    
    // Disable button and show loading
    addButton.disabled = true;
    loading.textContent = 'Adding device...';
    loading.style.display = 'block';
    
    logToHomey('CREATING DEVICE NOW --> ' + JSON.stringify(deviceData, null, 2));
    
    // Create the device directly with properly formatted data
    Homey.createDevice(deviceData)
      .then(() => {
        logToHomey('Device created successfully');
        Homey.showView('add_device_finish');
      })
      .catch(error => {
        logToHomey('Error creating device: ' + error.message);
        errorMessage.textContent = `Could not add device: ${error.message || error}`;
        errorMessage.style.display = 'block';
        loading.style.display = 'none';
        addButton.disabled = false;
      });
  });
  
  // Check for Enter key in the IP input
  ipAddressInput.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      testButton.click();
    }
  });
</script> 