<!-- Manual entry page for WLED devices -->
<link rel="stylesheet" href="./wled-pair-styles.css">

<div class="container">
  <div class="title">Add WLED Device Manually</div>

  <form id="manual-form" class="form">
    <div class="form-group">
      <label for="deviceAddress">IP Address:</label>
      <input type="text" id="deviceAddress" name="deviceAddress" required placeholder="192.168.x.x">
    </div>
    
    <div class="button-container">
      <button id="testConnectionBtn" type="button" class="primary-button">Test Connection</button>
    </div>
  </form>

  <div id="device-card" class="device-card">
    <div id="device-icon" class="device-icon">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
        <rect x="4" y="12" width="24" height="8" rx="4" ry="4" fill="var(--text-color-secondary)"/>
        <circle cx="9" cy="16" r="2" fill="var(--accent-color)"/>
        <circle cx="16" cy="16" r="2" fill="var(--accent-color)"/>
        <circle cx="23" cy="16" r="2" fill="var(--accent-color)"/>
      </svg>
    </div>
    <div class="device-name" id="device-name"></div>
    <div class="device-ip" id="device-ip"></div>
    <div class="device-status" id="device-status"></div>
  </div>
  
  <div id="add-container" class="add-container">
    <button id="addDeviceBtn" class="primary-button" style="min-width: 200px; font-size: 16px; padding: 12px 30px;">Add Device</button>
  </div>
</div>

<script>
  // Apply correct theme
  document.addEventListener('DOMContentLoaded', function() {
    // Try to detect Homey's theme
    const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    // Apply theme class
    if (isDarkMode) {
      document.body.classList.add('homey-theme-dark');
    } else {
      document.body.classList.add('homey-theme-light');
    }
  });

  // Helper to log to Homey
  function logToHomey(message) {
    // Send log to Homey driver
    Homey.emit('log', `[MANUAL ENTRY] ${message}`)
      .catch(err => console.error('Error logging to Homey:', err));
  }

  // Debug logging
  logToHomey('MANUAL ENTRY PAGE LOADED');

  // Get form elements
  const manualForm = document.getElementById('manual-form');
  const deviceAddressInput = document.getElementById('deviceAddress');
  const testConnectionBtn = document.getElementById('testConnectionBtn');
  const addDeviceBtn = document.getElementById('addDeviceBtn');
  
  // Get device card elements
  const deviceCard = document.getElementById('device-card');
  const addContainer = document.getElementById('add-container');
  const deviceNameElement = document.getElementById('device-name');
  const deviceIpElement = document.getElementById('device-ip');
  const deviceStatusElement = document.getElementById('device-status');
  
  // Reset UI state when the page loads
  deviceAddressInput.value = '';
  deviceCard.style.display = 'none';
  addContainer.style.display = 'none';

  // Store device data from successful test
  let discoveredDeviceData = null;

  // Test connection
  testConnectionBtn.addEventListener('click', function() {
    const address = deviceAddressInput.value.trim();
    
    if (!address) {
      showStatus('error', 'Please enter an IP address');
      return;
    }
    
    // Disable the button during test
    testConnectionBtn.disabled = true;
    testConnectionBtn.textContent = 'Testing...';
    
    // Reset UI
    deviceCard.style.display = 'none';
    addContainer.style.display = 'none';
    discoveredDeviceData = null;
    
    // Show testing status
    showStatus('loading', 'Testing connection...');
    
    // Send test request to driver
    Homey.emit('test_connection', { address })
      .then(result => {
        testConnectionBtn.disabled = false;
        testConnectionBtn.textContent = 'Test Connection';
        
        if (result.success) {
          // Store device data for later use
          discoveredDeviceData = result.deviceData;
          
          // Show success message and device info
          showStatus('success', 'Connection successful!');
          displayDeviceInfo(
            discoveredDeviceData.name, 
            discoveredDeviceData.settings.address, 
            'Connected'
          );
          
          // Show add button
          addContainer.style.display = 'block';
          addDeviceBtn.style.display = 'block';
        } else {
          showStatus('error', result.message || 'Connection failed');
          displayDeviceInfo('Unknown device', address, 'Connection failed');
          
          // Don't show any buttons if there was an error
          addContainer.style.display = 'none';
        }
      })
      .catch(error => {
        testConnectionBtn.disabled = false;
        testConnectionBtn.textContent = 'Test Connection';
        
        showStatus('error', error.message || 'Connection test failed');
        displayDeviceInfo('Error', address, 'Unable to connect');
        
        // Don't show any buttons if there was an error
        addContainer.style.display = 'none';
      });
  });

  // Add device button
  addDeviceBtn.addEventListener('click', function() {
    if (!discoveredDeviceData) {
      showStatus('error', 'No device information available');
      return;
    }
    
    // Disable button to prevent multiple submissions
    addDeviceBtn.disabled = true;
    addDeviceBtn.textContent = 'Adding...';
    
    logToHomey(`Adding discovered device: ${JSON.stringify(discoveredDeviceData)}`);
    
    // Send the device to the driver
    Homey.emit('selected_device', discoveredDeviceData)
      .then(() => {
        logToHomey('Device selection sent to driver');
        // Navigate to add_device view
        Homey.showView('add_device');
      })
      .catch(error => {
        logToHomey(`Error in device selection: ${error.message || error}`);
        showStatus('error', 'Failed to add device');
        // Re-enable button
        addDeviceBtn.disabled = false;
        addDeviceBtn.textContent = 'Add Device';
      });
  });
  
  // Helper to show status in the device card
  function showStatus(type, message) {
    deviceStatusElement.textContent = message;
    deviceStatusElement.className = 'device-status';
    
    if (type === 'success') {
      deviceStatusElement.classList.add('success');
    } else if (type === 'error') {
      deviceStatusElement.classList.add('error');
    } else if (type === 'loading') {
      deviceStatusElement.classList.add('loading');
    }
  }
  
  // Helper to display device info
  function displayDeviceInfo(name, address, status) {
    deviceNameElement.textContent = name || 'Unknown device';
    deviceIpElement.textContent = address;
    
    // Set status class after setting text to ensure correct styling
    deviceStatusElement.textContent = '';
    deviceStatusElement.className = 'device-status';
    
    if (status === 'Connected') {
      deviceStatusElement.classList.add('success');
      deviceStatusElement.textContent = 'Connected';
    } else if (status.includes('Error') || status.includes('failed') || status.includes('Unable')) {
      deviceStatusElement.classList.add('error');
      deviceStatusElement.textContent = status;
    } else {
      deviceStatusElement.textContent = status;
    }
    
    deviceCard.style.display = 'flex';
  }
</script>