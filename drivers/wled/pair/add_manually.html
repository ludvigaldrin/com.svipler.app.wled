<style>
  .container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    text-align: center;
  }
  
  .loading {
    margin: 20px 0;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top-color: #00adef;
    animation: spin 1s ease-in-out infinite;
    margin: 0 auto 20px auto;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .error {
    color: red;
    margin: 20px 0;
  }
  
  .success {
    color: green;
    margin: 20px 0;
  }
  
  .button {
    margin: 10px 0;
    padding: 15px;
    background-color: #00adef;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    text-align: center;
  }
</style>

<div class="container">
  <div id="loading-container">
    <p>Connecting to WLED device...</p>
    
    <div class="loading">
      <div class="spinner"></div>
    </div>
  </div>
  
  <div id="success-container" style="display: none;">
    <p class="success">Device added successfully!</p>
  </div>
  
  <div id="error-container" style="display: none;">
    <p class="error" id="error-message"></p>
    <button id="back-button" class="button">Go Back</button>
  </div>
  
  <div id="debug-info" style="margin-top: 20px; text-align: left; font-size: 12px; color: #666;"></div>
</div>

<script>
  Homey.setTitle(Homey.__('pair.add_manually.title'));
  
  const loadingContainer = document.getElementById('loading-container');
  const successContainer = document.getElementById('success-container');
  const errorContainer = document.getElementById('error-container');
  const errorMessage = document.getElementById('error-message');
  const debugInfo = document.getElementById('debug-info');
  const backButton = document.getElementById('back-button');
  
  function log(message) {
    console.log(message);
    if (typeof message === 'object') {
      message = JSON.stringify(message);
    }
    debugInfo.innerHTML += `${message}<br>`;
  }
  
  function showError(message) {
    log(`Error: ${message}`);
    errorMessage.innerText = message;
    loadingContainer.style.display = 'none';
    errorContainer.style.display = 'block';
  }
  
  function showSuccess() {
    log('Device added successfully');
    loadingContainer.style.display = 'none';
    successContainer.style.display = 'block';
    
    // Automatically complete pairing after 2 seconds
    setTimeout(() => {
      log('Completing pairing...');
      Homey.done();
    }, 2000);
  }
  
  // Handle back button
  backButton.addEventListener('click', () => {
    log('Going back to manual entry');
    Homey.showView('manual_entry');
  });
  
  // Start the process to add the device
  log('Starting add_manually process');
  
  Homey.emit('add_manually')
    .then(devices => {
      log(`Received devices: ${JSON.stringify(devices)}`);
      
      if (devices && devices.length > 0) {
        log(`Creating device: ${JSON.stringify(devices[0])}`);
        
        return Homey.createDevice(devices[0])
          .then(() => {
            showSuccess();
          })
          .catch(error => {
            showError(`Could not add device: ${error.message || error}`);
          });
      } else {
        showError('No device found to add. Please try again.');
      }
    })
    .catch(error => {
      showError(`Error: ${error.message || error}`);
    });
</script> 